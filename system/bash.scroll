# -*- python -*-
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.  This file is offered as-is,
# without any warranty.  [GNUAllPermissive]
from dragonsuite import *

i_use_info     = get('I_USE_INFO',     'y').lower().startswith('y')
i_use_man      = get('I_USE_MAN',      'y').lower().startswith('y')
i_use_readline = get('I_USE_READLINE', 'y').lower().startswith('y')
i_use_locale   = get('I_USE_LOCALE',   '*')

pkgname = 'bash'
_pkgver = '4.2'
_ver = _pkgver.replace('.', '')
_patch = 45
pkgver = "%s.%i" % (_pkgver, _patch)
pkgdesc = 'The GNU Bourne Again shell'
upstream = 'http://www.gnu.org/software/bash/bash.html'
arch = ['x86_64']
freedom = SOFTWARE | MEDIA
license = ['GPL3']
private = SUPPORTED
groups = ['base']
depends = ['glibc', 'curses', 'filesystem']
if i_use_readline:
    depends.append('readline>=6.1')
makedepends = ['gcc'] + depends
provides = ['sh']
source = ['http://ftp.gnu.org/gnu/bash/bash-%s.tar.gz' % _pkgver,
          'bash@bash-4.2-do-not-use-memcpy-on-overlapping-memory.patch']
source += ['bash@equestria.bash' + f for f in ['rc', '_logout']]
source += ['bash@pony.bash' + f for f in ['rc', '_profile', '_logout']]
source += ['http://ftp.gnu.org/gnu/bash/bash-%s-patches/bash%s-%03i' % (_pkgver, _ver, p + 1) for p in range(_patch)]
noextract = source[1:]
sha3sums = ['D55A07FF7F11843E2E1DBEAA67D1C3F69D04213616A1C84F7A8EF389AF0BA974D7D4A7A3556FAAC4AAF8347F1FC879862D922D552C3D4B237D0BB604ADAE32CD37C2966CC33DA862']
sha3sums += [None] * 6
sha3sums += ['552F0BDBC502FE19FDE7F4D0521B37AFC62B3F903A718EE82BDD277F32D19891C3864AF25D5AA8A3E2F06B15833285174146B40ACB7AA5941084B477EB1437CC41102901ADE9346E',
             'CFCF8CBDD9B18874A4BEA8A00288E562A0D812918FE6C2472D5F9BC88A313AA1BEA230C17676E507FBDC7E44CBC0CB8F0FBCFFB7535C1DBAC33CA1B3796A183F0AFC099629B0AD92',
             '110917A5330F289146E6A106A58F0719BBDC6782D83E461C950E0F3B0437E2C4C5AA85C0CCD4FA27ADFEA78B6D8C3187166CAEAADDFEB938A9C7403DD8D377795E6727D3EC389A30',
             '4C733E32EBA7D4279DAB20D8F92D328F6E9D699FFA34A9D0499AF6E4CA160E9951EACB86F16ACF42BD3C8D16894385782AF550F965F4B1F9D2C3E44F22DABFC07A4327FBEC76FD99',
             'CD2CF7B902714DCA707FAEC409BBE1FEAB61C502C72EEFC6F39EAB284FA5F7437099049A8437FC7D0BE26713B01E3E5D5C9425951935BBD59E70271F0F4814CEB8D27FACFEB886A1',
             '25B1F02559C9B4BFA462391815FF3CF153B324896D643E87118DDF87E560EE3654CE0CA206811CF122EE6CDAFC9033F06A0ED734A57A5D74EE8B32F0B2F01DC58A77294B922321B4',
             'EAD83F4E10C76C6608EC91A10B0FBA6A384A4BC161EF8824AE45C7FD225FD48208BF7889195202584601112D3B924196D2B7E2A8710354375619F09739519C4E548AB46FE2844D01',
             '14C747DD2060217C2B4E17C541115DAEE276983A0AF23BA4B6E758B5B5CBD76044FE4E58C11CA7E6F67A6168D6EBED9999C165C1C38C3722FFB247BB005BE6860FAB79A320B04CAF',
             'E5D854764C4485AFD97D5156EE1ED081B0DF4362D5FB393B80F8D411746F637D2FD427B7F89E1937C340C0EA8CB9A01C6CD84269098D9C19AC4927F2A8D3511E20BAB3C95C7A2353',
             '619C8D918D7622037757E03D0CBAC8F3112BD9E5CC8F384F67392DF78FD7938F809524BEA4A6559696275CD52C8A33C167A0A00783A9B0FF9BC9908F5AD58F819CBEE481BD984E1E',
             '8E7272FAE07AB28A3EACA1134F2344F20CDF7074274AFB89627A467B19AB6A24E649E38EA86FF6F09A5C5665BF73C1630B17205AEF4CB065DA985CC032260FB717DC60763AA4907C',
             '370B40735B56D62E5D079A6947D6ED67BF23F5FE1D2D44A8DBB12B34D3B43C0B4872C3F4C91D65B39C1D6A1C3D5F923842F3ABDD44B22BBE4F5953143569AB1A0D685117A3CF5137',
             '37EDE453EB7CE2F2F263D40ADAC9B7143B449DBF95D609EE4CECAEE8E360A63BDC3C6101DA8598F8B58F26698DFF600A2C3B871618FF60B6CDC6475F5A2C5EAD6A0DB37D09D5660F',
             'EBA6D0CA98EA1CB30E0A353DC7C4CB634C4DB16FDE6CEF84E9AB0805B29ABAABA3E834B25D094BF8C2D090BCC7A702E632D80D97D91AD909D9FC909519941ACED5008D8634E5475F',
             '7AF33D43BC5223A6EE4BBBD6C4B2301E7A4E6CF750138635F97F4C023C2DE218DF8B36B37A392902B51C308B7CADCCAF9B6E8271567B51ABB7907FE6F7680D141FC9F6CBF9BC4A98',
             '960DA1F756165C953EBE982391B2C37D159D7EA7736A0E6F8C78B9207703DFCE4D71B340AD6853570EFA8E3637809F32DC1165C8045735971893E3CE8233753E711AEFFB55508305',
             '09DF5F368EFA4F4F1539FD976417569B5C8892EB322E1C5CD1183BFBC742CDA9C41B3B3B886DD0C8B745389D48ABE4CE6032607A7878CF7762B6BD1D6A5B4E69C0ABFEF771CC66A6',
             '067DFE74C04E378C909C411891DA9593018911B84F8A62E67F72B39C5C1E2A0231E490DBE967FB9827781A71A1BD2FFA43F36BC1B35AF69B311E0496D0CE84B1F2FA8A0E60DE4497',
             '15B00175C71CC9D6A51528BE0D9731B27A11842824F22175BB7DD6BE71BA7B341605ED8F139348F7FEA77098ED3BFBD985F214C1B31086221523B306597E88EBE7D31C3CF0538B03',
             '03EA4EE8AD0E2E05767BD30D918EAC5B7B634350B4F563F5D62E21BB8A7F630225D53B750F64BC75D4C50657E63B1D27986C030B955DA283AB95CF68AFB4CECA9B372A985770F0B9',
             '48C864C0593E3A4E6542829CDFCD7BEB47C957FBDD8BDC5102DC0B46EB3B90B52A501A20FFA374FCB2B9E6A5B3BC4378A7F3001725E5534D4B08E4AF71246CBED834292C35543E71',
             '3128CBBC996AD3BC9B5D3BD945A06F2716C954CFF7E1E36C923576130F8CB66EE55DEF45652C1DDCDDB7903CFC51B3B06EE828D5068F96F95018ADD83E257BC405C650092D05E9C7',
             '28E73352808158AB2FC5A5468D5836838F837F88C84E20D1145996DEDA1ECFC392A012D6A025B93BEFF1D8ABEF3AFAD43A158293672109253DE46995D3D978115EE76B174A83D216',
             '8A3A1A073A6337941812C1B664F70083E9FF6835BB22663C62BB1AAA0BBC01740FCCED0C3B472BBE30246109C134C9F4CD38D9B231CDF14942FD72C39198E06619C34A903170A982',
             '74FAEE919E29E1F5CA704D748275217E85C0626F5D9147859669D377FB92B980ED1AF0373AE603AFA8CB73AEAAA93715AA7DF1250E6A4587C47AB9FE088B5D61540854E585689751',
             'A593605D2B445608E2E4FCFFBB40C178B673115683BF856D5AAC9CEF6126D86E86BAABD7B691C8BCAF68C4F5304F45C29CB533BD946485DF9FD2276F93F2FED4A1AE4A003A73012C',
             '57CAFD27E5F48194E32857FD07898958D63B58EC5C44997D798ABB051279AB35A3971A1F697E0BC51D85B85A29F0B3C0B1312EF0709271D52126142CD9C811A2ABCA37219F915EC9',
             '172DE2B50D841F63E000D6DF9AD56CAA1CEA3482E35146F5D94ACC0DC88F2443F38DAB69C87DC45A68D3B3B0E07AFC0183345CE02E0E796FDFBCF29A73B169348AA9C249B021CC66',
             '62B85C557474C7E3E05BBABD98CAF20E926B7D080C637C6DA77608DDC319A0635E3DAAAD7329C55CCF3CF0B234E08B74B42A156EFDADEADCA9463EF095B63F962DC3157E9DCBE6C5',
             'CC9D11915FB6405ADC28421307D8BE4BB6762A395BD39381BFFC45B38E61EC2856DED1053C39F33F9F9CCF36E772996016E3A44446DA80525B4DD49BE1E3EE476A5F123EB73A1D12',
             '31CDC0E1FC3919643A368D6D4783D878B97E97C198014F4786C279F20636763D11EF127CB334B212DE1377DD6DFD34D853618788805371FB896D73A59063E5C715909D48EAAA6C4B',
             'AA64CF77FAC17E036957023E3CFCE28318614004A96FDED81C420663F9D3A6BDC802FD8506DB30FA4D57F6624BD8FEE9814188BC81B50500C3EEFEBD172E89D668CF4557EB7FA787',
             'E648150FD45E0CCCBBBAD81D552DF78126751F7965B5DCDA614F6C5A1E522E627B7693478E68180D2D4D679EEDA7701C2C02A55DCA24DD11902AFBD875CF1416F4DE8E3FA1175903',
             '22E45895A0B3DA5CCD87A8857294DBEBEC0B150505907AB05F7099F13360160ADA1B6E75AD18E788E5ECAF965710C884BE65760C6ABB4D354CCEC0D2F892DA6A127786B0617553F5',
             '168F5E56ACADDAB7F60125899E8506FE68CF92D5A173C50A810DC7734AFFD92DE5591F1262FB7C58213650F33034F22BC4BBD45BB60AA0E035438BF57E37A7B9C48B79B24C952578',
             '9B6971CC1D2AAE6623BC1AC22A496E018FA9DA276F6BCF323C1923E874B53DC75458F413177A1277665E7E774A6A9F2B9B815EDBE2878B884B158E1E9602D6704E62FDF52C6C3060',
             'A3F46D9639FDD2430B8DC5A04F825B7723A2FAC934CC55A1F7264882131C2EFBDE0F26B99AF79FF8219F37FCA44504722838FC4E6737EB7ECEC6AA4783FD6B562C7310D2ECC1B364',
             '0313C719C126B2D8AB33CD782479C78A4DAFCCE0B30FF2955ABE749949820AEA8EE55DB2C2DD14B4FA93A94294F7BFBEA82CF9F408A5CBBBF2F608AFF9D083DFAE0E7582E48AF059',
             '400E9FD88D6B52209A85EB389BE67C23330C910D09362FE2855F84B43EA977625A1D6FC59A890F83E9DF762E8C894B90478ACD8CDDE8E3045E31D1A8DEB279A5A4902C7F80AE0462',
             'A74065F686F963A8FE44CA5482ADE5209EA02C775EDB834CD5DBD914A94BDD7FF5813E3C58FE73E7DE829F4949069A15D5E9CE7E61E3A68637F832798F58DDB1D36F5E3EE3A91835',
             '9584DCEBA5F2A72D4B20ACE745D5272E558428F14DDF95F94B55C9000FD4322894B8140256EC273CA9B7D30292EB0EC2E06AA6B2FE277D6AA15ABA934563D980C360043D953B3399',
             'C77354A0C555871382527C12F17DB7E0D061F00B1E0CA945E5BB0EE0E516F499390D3E3E64B43B95E94B0E190EACC67C64085DE73E2515873D66394855B1ABA07BDA5A293A2285E9',
             '649F21D738B63BB88654B54B921640EF53649834EEAA30666636F4C6336E5E5372ADC57541CE022E01335BA4E9586C9B676629D623F42354EA4B4D06C507EA63AB57FEAB4DF1B6C5',
             '24D1A3C90C68F47CAED3B01A1C15FF88C2DAC5D205719CD0401BC48F7BB23F809C60FA63797B7906E5AF8BBE9D1F0FFE80FB20AF033FCD426974847862767DAD2B033A04764A0A74',
             '07146043D2EFBE7C2D0758550F3A6B74F9F5DC1A030FCE8E9085177660BBC141E906DAE0659117CB2A8D917CEEBF44FD5523A31E40DC43546AFFBB03E3C30704EC5462C8C857238E']


_prefix  = lambda private : (path('~/.local') if private else '/usr')
_eprefix = lambda private : (path('~/.local') if private else '')
_sysconf = lambda private : (path('~/.config') if private else '/etc')
_skel    = lambda private : (path('~') if private else ('%s/skel' % _sysconf(private)))


def ride(private):
    execute('bash')


def build(startdir, srcdir, pkgdir, private):
    cd('%s/bash-%s' % (srcdir, _pkgver))
    for p in range(_patch):
        patch('%s/bash%s-%03i' % (srcdir, _ver, p + 1), strip = 0, forward = False)
    patch('bash@bash-4.2-do-not-use-memcpy-on-overlapping-memory.patch', forward = False)
    DEFAULT_PATH_VALUE  = '\'"%s"\'' % ':'.join(['/usr/local/bin', '/usr/bin', '/bin'])
    STANDARD_UTILS_PATH = '\'"%s"\'' % ':'.join(['/usr/bin', '/bin'])
    SYS_BASHRC          = '\'"%s"\'' % '/etc/bash.bashrc'
    SYS_BASH_LOGOUT     = '\'"%s"\'' % '/etc/bash.bash_logout'
    CFLAGS = '-DDEFAULT_PATH_VALUE=%s -DSTANDARD_UTILS_PATH=%s -DSYS_BASHRC=%s -DSYS_BASH_LOGOUT=%s'
    CFLAGS %= (DEFAULT_PATH_VALUE, STANDARD_UTILS_PATH, SYS_BASHRC, SYS_BASH_LOGOUT)
    CFLAGS = '%s %s' % (get('CFLAGS', ''), CFLAGS)
    export('CFLAGS', CFLAGS)
    execute('./configure',
            '--exec-prefix=' + _eprefix(private),
            '--prefix=' + _prefix(private),
            '--with-curses',
            '--enable-readline' if i_use_readline else '--disable-readline',
            '--without-bash-malloc',
            '--with-installed-readline' if i_use_readline else '--without-installed-readline')
    make()


def check(startdir, srcdir, pkgdir, private):
    cd('%s/bash-%s' % (srcdir, _pkgver))
    make('check')


def package(startdir, srcdir, pkgdir, private):
    cd('%s/bash-%s' % (srcdir, _pkgver))
    make('DESTDIR=' + pkgdir, 'install')
    
    if not private:
        for f in ['rc', '_logout']:
            install('bash@equestria.bash' + f, pkgdir + _sysconf(private) + '/bash.bash' + f, parents = True, mode = 0o644)
    
    for f in ['rc', '_profile', '_logout']:
        install('bash@pony.bash' + f, pkgdir + _skel(private) + '/.bash' + f, parents = True, mode = 0o644)
    
    if not private:
        ln('/etc/alternatives.providers/sh/bash', '/bin/sh', parents = True)
        ln('/bin/bash', '/etc/alternatives.providers/sh/bash', parents = True)
    
    _licenses = pkgdir + _prefix(private) + '/share/licenses'
    ln('/usr/share/licenses/common/GPL3', '%s/%s' % (_licenses, pkgname), parents = True)
    
    if not i_use_info:
        rm_r(pkgdir + _prefix(private) + '/share/info')
    if not i_use_man:
        rm_r(pkgdir + _prefix(private) + '/share/man')
    filter_locale(i_use_locale, pkgdir, _prefix(private))


def post_install(tmpdir, rootdir, installedfiles, private):
    post_install_info(rootdir, installedfiles, private, i_use_info)
    if private:
        install_alternative(rootdir, 'sh', 'bash')


def pre_upgrade(tmpdir, rootdir, installedfiles, private):
    pre_upgrade_info(rootdir, installedfiles, private)


def post_upgrade(tmpdir, rootdir, installedfiles, private):
    post_upgrade_info(rootdir, installedfiles, private, i_use_info)


def pre_uninstall(tmpdir, rootdir, installedfiles, private):
    pre_uninstall_info(rootdir, installedfiles, private)
    if private:
        uninstall_alternative(rootdir, installedfiles, 'sh', 'bash')

